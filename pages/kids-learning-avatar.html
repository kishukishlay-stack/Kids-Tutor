<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Buddy â€” Learn A-Z & Phonics</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --sky:#1a2a4a;--sky2:#0f1e38;--sky3:#0a1228;
  --sun:#FFD93D;--coral:#FF6B6B;--green:#6BCB77;
  --purple:#c77dff;--blue:#6EC6F5;--pink:#ff85c2;
  --white:#fff;--light:#e8f0ff;--gold:#FFD93D;
  --border:rgba(255,255,255,0.1);--glass:rgba(255,255,255,0.06);
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Nunito',sans-serif;background:var(--sky3);color:var(--white);overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(ellipse 80% 50% at 30% 20%,rgba(108,203,255,.08) 0%,transparent 60%),
  radial-gradient(ellipse 60% 50% at 70% 80%,rgba(199,125,255,.07) 0%,transparent 60%);
  pointer-events:none;z-index:0;}

#app{position:relative;z-index:1;display:grid;grid-template-columns:360px 1fr;height:100vh;max-width:1300px;margin:0 auto;}

/* LEFT */
#left{background:rgba(15,30,56,.95);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.ptop{padding:16px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--sun),var(--coral));display:flex;align-items:center;justify-content:center;font-size:20px;}
.appname{font-family:'Fredoka One',cursive;font-size:20px;color:var(--white);}
.appsub{font-size:10px;color:rgba(255,255,255,.5);letter-spacing:1.5px;text-transform:uppercase;}

/* BUDDY STAGE */
.stage{flex:1;display:flex;flex-direction:column;align-items:center;padding-top:6px;overflow:hidden;position:relative;
  background:radial-gradient(ellipse 80% 70% at 50% 55%,rgba(110,198,245,.06) 0%,transparent 70%);}
#buddyCanvas{display:block;}

.srow{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:50px;padding:5px 14px;font-size:12px;color:var(--sun);font-weight:700;margin:2px 0 4px;font-family:'Nunito',sans-serif;}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:sdp 1.5s infinite;}
.sdot.sp{background:var(--sun);animation:sdp .35s infinite;}
.sdot.th{background:var(--blue);animation:sdp .7s infinite;}
.sdot.li{background:var(--coral);animation:sdp .3s infinite;}
@keyframes sdp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.75)}}

.viz{display:flex;gap:3px;align-items:center;height:28px;margin-bottom:2px;opacity:0;transition:opacity .3s;}
.viz.on{opacity:1;}
.vb{width:4px;border-radius:2px;background:linear-gradient(to top,var(--sun),#fff59d);animation:vba .5s ease infinite;}
.vb:nth-child(1){height:6px}.vb:nth-child(2){height:13px;animation-delay:.05s}.vb:nth-child(3){height:20px;animation-delay:.1s}
.vb:nth-child(4){height:26px;animation-delay:.15s}.vb:nth-child(5){height:20px;animation-delay:.2s}
.vb:nth-child(6){height:13px;animation-delay:.25s}.vb:nth-child(7){height:6px;animation-delay:.3s}
@keyframes vba{0%,100%{transform:scaleY(.3)}50%{transform:scaleY(1)}}

.uviz{display:flex;gap:3px;align-items:center;height:28px;margin-bottom:2px;opacity:0;transition:opacity .3s;}
.uviz.on{opacity:1;}
.uvb{width:4px;border-radius:2px;background:linear-gradient(to top,var(--coral),#ffb3b3);animation:vba .3s ease infinite;}
.uvb:nth-child(1){height:8px}.uvb:nth-child(2){height:17px;animation-delay:.04s}.uvb:nth-child(3){height:25px;animation-delay:.08s}
.uvb:nth-child(4){height:28px;animation-delay:.12s}.uvb:nth-child(5){height:25px;animation-delay:.16s}
.uvb:nth-child(6){height:17px;animation-delay:.2s}.uvb:nth-child(7){height:8px;animation-delay:.24s}

/* BIG MIC BUTTON */
.mic-wrap{display:flex;flex-direction:column;align-items:center;gap:5px;margin:4px 0 6px;}
#micBtn{width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;transition:all .22s;position:relative;background:linear-gradient(135deg,var(--sun),var(--coral));box-shadow:0 6px 22px rgba(255,107,107,.4);}
#micBtn:hover{transform:scale(1.07);}
#micBtn.on{background:linear-gradient(135deg,var(--coral),#b91c1c);animation:mpulse .7s infinite;}
#micBtn.speaking{background:linear-gradient(135deg,var(--blue),#1d4ed8);}
@keyframes mpulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.mring{position:absolute;inset:-6px;border-radius:50%;border:2px solid var(--sun);opacity:0;animation:mra 1.5s infinite;}
.mring2{animation-delay:.5s;}
@keyframes mra{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.5);opacity:0}}
.mlbl{font-size:11px;color:rgba(255,255,255,.6);font-weight:700;letter-spacing:.5px;font-family:'Nunito',sans-serif;}
.mlbl.on{color:var(--coral);}
.mlbl.sp{color:var(--blue);}

/* ALPHABET SCROLL */
.alpha-bar-label{font-size:10px;color:rgba(255,255,255,.45);letter-spacing:2px;text-transform:uppercase;padding:4px 16px 4px;font-weight:600;}
.alpha-bar{display:flex;overflow-x:auto;gap:5px;padding:0 14px 10px;scrollbar-width:none;}
.alpha-bar::-webkit-scrollbar{display:none;}
.ab{width:34px;height:34px;border-radius:9px;background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-family:'Fredoka One',cursive;font-size:15px;color:rgba(255,255,255,.7);cursor:pointer;flex-shrink:0;transition:all .18s;}
.ab:hover,.ab.active{background:linear-gradient(135deg,var(--sun),var(--coral));border-color:transparent;color:var(--sky3);transform:scale(1.1);}

/* MODE TABS */
.mode-tabs{display:flex;gap:6px;padding:4px 14px 8px;}
.mtab{flex:1;padding:8px 4px;border-radius:10px;border:1.5px solid rgba(255,255,255,.1);background:transparent;color:rgba(255,255,255,.55);font-family:'Nunito',sans-serif;font-size:11.5px;font-weight:700;cursor:pointer;transition:all .18s;text-align:center;}
.mtab.active{background:linear-gradient(135deg,rgba(255,217,61,.2),rgba(255,107,107,.15));border-color:rgba(255,217,61,.4);color:var(--sun);}
.mtab:hover:not(.active){background:rgba(255,255,255,.06);}

/* STARS */
.stars-row{display:flex;justify-content:center;align-items:center;gap:6px;padding:0 14px 8px;}
.star-badge{background:rgba(255,217,61,.12);border:1.5px solid rgba(255,217,61,.25);border-radius:50px;padding:5px 14px;font-size:12px;font-weight:800;color:var(--sun);}

/* RIGHT */
#right{display:flex;flex-direction:column;overflow:hidden;}
.topbar{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(10,18,40,.9);backdrop-filter:blur(10px);}
.tbt{font-family:'Fredoka One',cursive;font-size:22px;color:var(--white);}
.tbs{font-size:12px;color:rgba(255,255,255,.5);margin-top:2px;}
.tbbtns{display:flex;gap:7px;}
.tbb{width:36px;height:36px;border-radius:9px;border:1.5px solid var(--border);background:var(--glass);color:rgba(255,255,255,.5);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.tbb:hover{border-color:rgba(255,217,61,.4);color:var(--sun);}

/* LESSON PANEL */
#lesson-panel{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:0;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent;}
#lesson-panel::-webkit-scrollbar{width:3px;}
#lesson-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px;}

/* LETTER HERO */
.letter-hero{display:flex;flex-direction:column;align-items:center;text-align:center;padding:20px 20px 16px;background:linear-gradient(135deg,rgba(255,217,61,.08),rgba(255,107,107,.06));border:1.5px solid rgba(255,217,61,.15);border-radius:24px;margin-bottom:16px;animation:pop .4s cubic-bezier(.34,1.56,.64,1);}
@keyframes pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.big-letter{font-family:'Fredoka One',cursive;font-size:100px;line-height:1;background:linear-gradient(135deg,var(--sun),var(--coral));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 4px 12px rgba(255,217,61,.3));}
.letter-word{font-family:'Fredoka One',cursive;font-size:26px;color:var(--white);margin:4px 0;}
.letter-emoji{font-size:52px;margin:4px 0;}
.letter-phonics{background:rgba(110,198,245,.15);border:1.5px solid rgba(110,198,245,.25);border-radius:50px;padding:6px 18px;font-size:13px;font-weight:700;color:var(--blue);margin-top:6px;}
.letter-sentence{font-size:14px;color:rgba(255,255,255,.7);margin-top:8px;line-height:1.5;font-weight:600;}

/* CHOICES */
.choices-wrap{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.choice{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.12);border-radius:16px;padding:16px 12px;font-family:'Fredoka One',cursive;font-size:22px;color:var(--white);cursor:pointer;transition:all .18s;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;}
.choice:hover{background:rgba(255,255,255,.12);transform:translateY(-2px);}
.choice.correct{background:linear-gradient(135deg,rgba(107,203,119,.3),rgba(107,203,119,.15));border-color:var(--green);color:var(--green);animation:wiggle .4s ease;}
.choice.wrong{background:linear-gradient(135deg,rgba(255,107,107,.3),rgba(255,107,107,.15));border-color:var(--coral);color:var(--coral);animation:shake .4s ease;}
@keyframes wiggle{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* BUDDY SAYS */
.buddy-says{background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.1);border-radius:18px;padding:14px 18px;font-size:14px;font-weight:700;color:rgba(255,255,255,.9);line-height:1.5;margin-bottom:14px;position:relative;text-align:center;}
.buddy-says::before{content:'ğŸ’¬';font-size:16px;margin-right:6px;}

/* CHAT MESSAGES */
.chat-wrap{display:flex;flex-direction:column;gap:12px;}
.mr{display:flex;gap:10px;align-items:flex-end;animation:mf .28s ease;}
.mr.u{flex-direction:row-reverse;}
@keyframes mf{from{opacity:0;transform:translateY(9px)}to{opacity:1;transform:translateY(0)}}
.mav{width:30px;height:30px;border-radius:50%;border:1.5px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;background:rgba(15,30,56,.8);}
.mav.u{background:rgba(255,217,61,.15);}
.bub{max-width:440px;padding:11px 15px;border-radius:14px;font-size:13.5px;line-height:1.6;font-weight:600;}
.bub.b{background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.1);border-radius:4px 14px 14px 14px;}
.bub.u{background:linear-gradient(135deg,rgba(255,217,61,.2),rgba(255,107,107,.12));border:1.5px solid rgba(255,217,61,.25);border-radius:14px 4px 14px 14px;}
.mt{font-size:10px;color:rgba(255,255,255,.35);margin-top:3px;}
.mw{display:flex;flex-direction:column;}
.mw.u{align-items:flex-end;}
.dl-wrap{display:flex;gap:4px;align-items:center;height:18px;}
.dl{width:6px;height:6px;border-radius:50%;background:var(--sun);animation:dlb 1.1s infinite;opacity:.7;}
.dl:nth-child(2){animation-delay:.18s}.dl:nth-child(3){animation-delay:.36s}
@keyframes dlb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ACTION BTNS */
.action-row{display:flex;gap:10px;margin-bottom:14px;}
.abtn{flex:1;padding:13px;border-radius:14px;border:none;cursor:pointer;font-family:'Fredoka One',cursive;font-size:15px;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:7px;}
.abtn.hear{background:linear-gradient(135deg,var(--blue),#2980b9);color:white;box-shadow:0 4px 14px rgba(110,198,245,.3);}
.abtn.next{background:linear-gradient(135deg,var(--sun),var(--coral));color:white;box-shadow:0 4px 14px rgba(255,217,61,.3);}
.abtn.next:disabled{opacity:.4;cursor:not-allowed;}
.abtn:hover:not(:disabled){transform:translateY(-2px);}

/* PROGRESS */
.prog-bar-bg{background:rgba(255,255,255,.08);border-radius:50px;height:8px;margin-bottom:12px;overflow:hidden;}
.prog-bar-fill{height:100%;border-radius:50px;background:linear-gradient(90deg,var(--sun),var(--coral));transition:width .5s ease;}

/* LIVE TRANSCRIPT */
.live-t{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(15,24,41,.97);border:1.5px solid rgba(255,217,61,.3);border-radius:14px;padding:10px 20px;font-size:13px;color:var(--white);max-width:420px;text-align:center;display:none;z-index:100;backdrop-filter:blur(10px);font-weight:700;}
.live-t.show{display:block;}
.lt-lbl{font-size:10px;color:var(--sun);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px;}

/* INPUT */
.inp-zone{padding:10px 24px 16px;border-top:1px solid var(--border);background:rgba(10,18,40,.85);}
.ibox{display:flex;align-items:center;gap:9px;background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.1);border-radius:13px;padding:8px 13px;}
.ibox:focus-within{border-color:rgba(255,217,61,.35);}
#ci{flex:1;background:transparent;border:none;outline:none;color:var(--white);font-family:'Nunito',sans-serif;font-size:13.5px;font-weight:600;}
#ci::placeholder{color:rgba(255,255,255,.3);}
.sndb{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--sun),var(--coral));border:none;color:var(--sky3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

@media(max-width:800px){
  #app{grid-template-columns:1fr;grid-template-rows:260px 1fr;}
  #left{flex-direction:row;align-items:center;padding:10px 12px;gap:8px;height:260px;}
  .ptop,.alpha-bar-label,.alpha-bar,.mode-tabs,.stars-row{display:none;}
  .stage{flex:none;width:140px;padding:0;}
  #buddyCanvas{width:130px!important;height:170px!important;}
  #right{height:calc(100vh - 260px);}
  #lesson-panel{padding:14px 16px;}
  .topbar{padding:10px 16px;}
}
</style>
</head>
<body>
<div id="app">
  <div id="left">
    <div class="ptop">
      <div class="logo">ğŸ¦‰</div>
      <div><div class="appname">Buddy Learns</div><div class="appsub">AI Tutor</div></div>
    </div>
    <div class="stage">
      <canvas id="buddyCanvas" width="320" height="280"></canvas>
      <div class="srow"><span class="sdot" id="sdot"></span><span id="slbl">Ready!</span></div>
      <div class="viz" id="viz"><div class="vb"></div><div class="vb"></div><div class="vb"></div><div class="vb"></div><div class="vb"></div><div class="vb"></div><div class="vb"></div></div>
      <div class="uviz" id="uviz"><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div><div class="uvb"></div></div>
      <div class="mic-wrap">
        <button id="micBtn" onclick="toggleListen()">
          <div class="mring"></div><div class="mring mring2"></div>
          <span id="micIcon">ğŸ™ï¸</span>
        </button>
        <div class="mlbl" id="mlbl">Tap to speak!</div>
      </div>
    </div>
    <div class="stars-row">
      <div class="star-badge">â­ <span id="starCount">0</span> Stars</div>
      <div class="star-badge">ğŸ“š <span id="lessonCount">0</span> Learned</div>
    </div>
    <div class="mode-tabs">
      <button class="mtab active" id="tab-learn" onclick="setMode('learn')">ğŸ“š Learn</button>
      <button class="mtab" id="tab-quiz" onclick="setMode('quiz')">ğŸ¯ Quiz</button>
      <button class="mtab" id="tab-chat" onclick="setMode('chat')">ğŸ’¬ Chat</button>
    </div>
    <div class="alpha-bar-label">A to Z</div>
    <div class="alpha-bar" id="alphaBar"></div>
  </div>

  <div id="right">
    <div class="topbar">
      <div><div class="tbt" id="topTitle">ğŸ”¤ Learning Alphabets</div><div class="tbs" id="topSub">Tap a letter or speak to Buddy!</div></div>
      <div class="tbbtns">
        <button class="tbb" onclick="prevLetter()">â†</button>
        <button class="tbb" onclick="nextLetter()">â†’</button>
        <button class="tbb" onclick="clearChat()">ğŸ—‘ï¸</button>
      </div>
    </div>
    <div id="lesson-panel"></div>
    <div class="inp-zone">
      <div class="ibox">
        <input id="ci" type="text" placeholder="Ask Buddy anythingâ€¦" maxlength="100">
        <button class="sndb" onclick="sendText()">â¤</button>
      </div>
    </div>
  </div>
</div>

<div class="live-t" id="liveT"><div class="lt-lbl">You said</div><div id="ltText">â€¦</div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUDDY CANVAS ANIMATION ENGINE
//  Cute round character: owl-inspired, kid-friendly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cv=document.getElementById('buddyCanvas'),ctx=cv.getContext('2d'),W=cv.width,H=cv.height;
const A={t:0,stT:0,state:'idle',breathY:0,headTilt:0,blinkT:0,blinkNext:150,pupX:0,pupY:0,browR:0,mOpen:0,mShape:0,phonIdx:0,phonTimer:0,waveT:0,waving:0,bounce:0,excite:0};
const PHON=[[0,0],[.4,1],[.75,2],[.55,1],[.1,0],[.7,2],[.45,1],[.05,0],[.85,2],[.55,1],[.2,0],[.65,2]];
const lerp=(a,b,t)=>a+(b-a)*t;

const C={
  body:'#4a90d9',bodyD:'#2c6bb5',bodyL:'#6eb4f7',
  belly:'#e8f4ff',
  wing:'#3a7ac9',wingL:'#5a9ae9',
  eye:'#fff',pupil:'#1a1a2e',
  beak:'#FFD93D',beakD:'#e6b800',
  blush:'rgba(255,150,120,0.3)',
  feet:'#FFD93D',
  star:'#FFD93D',
};

function drawBG(){
  const g=ctx.createRadialGradient(W/2,H*.7,10,W/2,H*.4,W);
  g.addColorStop(0,'#0f1e38');g.addColorStop(1,'#0a1228');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  // Stars
  ctx.fillStyle='rgba(255,255,255,0.4)';
  [[30,20],[80,35],[260,18],[300,40],[180,15],[50,60]].forEach(([x,y])=>{
    ctx.beginPath();ctx.arc(x,y,1+Math.sin(A.t+x)*.5,0,Math.PI*2);ctx.fill();
  });
}

function drawBuddy(cx2,cy2){
  const by=cy2+A.breathY+A.bounce;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.2)';
  ctx.beginPath();ctx.ellipse(cx2,by+66,38,8,0,0,Math.PI*2);ctx.fill();

  // Feet
  ctx.fillStyle=C.feet;
  ctx.beginPath();ctx.ellipse(cx2-14,by+64,10,5,-.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(cx2+14,by+64,10,5,.2,0,Math.PI*2);ctx.fill();

  ctx.save();
  ctx.translate(cx2,by);
  ctx.rotate(A.headTilt);

  // Wings (animated wave when waving)
  const wl=A.waving;
  // Left wing
  ctx.fillStyle=C.wing;
  ctx.beginPath();
  ctx.moveTo(-22,5);
  ctx.quadraticCurveTo(-52+wl*10,-10+Math.sin(A.waveT*2)*15*wl,-48+wl*8,-30+Math.sin(A.waveT)*20*wl);
  ctx.quadraticCurveTo(-35+wl*5,-20,-22,2);
  ctx.closePath();ctx.fill();
  ctx.fillStyle=C.wingL;
  ctx.beginPath();
  ctx.moveTo(-22,5);
  ctx.quadraticCurveTo(-46+wl*8,-8+Math.sin(A.waveT*2)*12*wl,-42+wl*6,-24+Math.sin(A.waveT)*16*wl);
  ctx.quadraticCurveTo(-32+wl*4,-16,-22,2);
  ctx.closePath();ctx.fill();

  // Right wing
  ctx.fillStyle=C.wing;
  ctx.beginPath();
  ctx.moveTo(22,5);
  ctx.quadraticCurveTo(52,2,50,-26);
  ctx.quadraticCurveTo(38,-16,22,2);
  ctx.closePath();ctx.fill();

  // Body
  const bg=ctx.createRadialGradient(-8,-10,5,0,0,42);
  bg.addColorStop(0,C.bodyL);bg.addColorStop(1,C.body);
  ctx.fillStyle=bg;
  ctx.beginPath();ctx.ellipse(0,10,36,44,0,0,Math.PI*2);ctx.fill();

  // Belly
  const belly=ctx.createRadialGradient(0,15,5,0,15,26);
  belly.addColorStop(0,'#ffffff');belly.addColorStop(1,C.belly);
  ctx.fillStyle=belly;
  ctx.beginPath();ctx.ellipse(0,18,20,26,0,0,Math.PI*2);ctx.fill();

  // Head
  const hg=ctx.createRadialGradient(-5,-30,4,0,-28,30);
  hg.addColorStop(0,C.bodyL);hg.addColorStop(1,C.body);
  ctx.fillStyle=hg;
  ctx.beginPath();ctx.ellipse(0,-28,28,28,0,0,Math.PI*2);ctx.fill();

  // Ear tufts
  ctx.fillStyle=C.bodyD;
  ctx.beginPath();ctx.moveTo(-16,-50);ctx.lineTo(-22,-62+A.excite*5);ctx.lineTo(-8,-52);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(16,-50);ctx.lineTo(22,-62+A.excite*5);ctx.lineTo(8,-52);ctx.closePath();ctx.fill();
  ctx.fillStyle=C.bodyL;
  ctx.beginPath();ctx.moveTo(-14,-51);ctx.lineTo(-18,-59+A.excite*4);ctx.lineTo(-8,-52);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(14,-51);ctx.lineTo(18,-59+A.excite*4);ctx.lineTo(8,-52);ctx.closePath();ctx.fill();

  // Eye rings (feather rings)
  ctx.fillStyle=C.bodyD;
  ctx.beginPath();ctx.ellipse(-11,-28,13,13,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(11,-28,13,13,0,0,Math.PI*2);ctx.fill();

  // Eyes
  const eyeOp=1-A.blinkT;
  ctx.fillStyle=C.eye;
  ctx.beginPath();ctx.ellipse(-11,-28,10,10*eyeOp,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(11,-28,10,10*eyeOp,0,0,Math.PI*2);ctx.fill();

  if(eyeOp>.1){
    const px=A.pupX*.15,py=A.pupY*.15;
    ctx.fillStyle='#1a1a2e';
    ctx.beginPath();ctx.ellipse(-11+px,-28+py,6,6*eyeOp,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(11+px,-28+py,6,6*eyeOp,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='white';
    ctx.beginPath();ctx.ellipse(-9+px,-30+py,2,2*eyeOp,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(13+px,-30+py,2,2*eyeOp,0,0,Math.PI*2);ctx.fill();
  }
  // Blink lid
  if(A.blinkT>.05){
    ctx.fillStyle=C.body;
    ctx.beginPath();ctx.ellipse(-11,-28-10*(1-A.blinkT),11,11,0,Math.PI,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(11,-28-10*(1-A.blinkT),11,11,0,Math.PI,Math.PI*2);ctx.fill();
  }

  // Eyebrows
  ctx.strokeStyle='rgba(255,255,255,0.8)';ctx.lineWidth=2.2;ctx.lineCap='round';
  const bl=A.browR*5;
  ctx.beginPath();ctx.moveTo(-19,-40-bl);ctx.quadraticCurveTo(-11,-43-bl,-4,-40-bl*.7);ctx.stroke();
  ctx.beginPath();ctx.moveTo(4,-40-bl*.7);ctx.quadraticCurveTo(11,-43-bl,19,-40-bl);ctx.stroke();

  // Blush
  ctx.fillStyle=C.blush;
  ctx.beginPath();ctx.ellipse(-19,-22,7,4,-.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(19,-22,7,4,.2,0,Math.PI*2);ctx.fill();

  // Beak
  const bmx=0,bmy=-18;
  const bkOpen=A.mOpen*8;
  // Upper beak
  const bk1=ctx.createLinearGradient(bmx,bmy-3,bmx,bmy+5);
  bk1.addColorStop(0,C.beak);bk1.addColorStop(1,C.beakD);
  ctx.fillStyle=bk1;
  ctx.beginPath();ctx.moveTo(bmx-9,bmy);ctx.quadraticCurveTo(bmx,bmy-8,bmx+9,bmy);ctx.quadraticCurveTo(bmx,bmy+2,bmx-9,bmy);ctx.closePath();ctx.fill();
  if(bkOpen>0.5){
    ctx.fillStyle='#361010';
    ctx.beginPath();ctx.ellipse(bmx,bmy+bkOpen*.5,5,bkOpen*.5,0,0,Math.PI*2);ctx.fill();
  }
  // Lower beak
  ctx.fillStyle=C.beakD;
  ctx.beginPath();ctx.moveTo(bmx-7,bmy);ctx.quadraticCurveTo(bmx,bmy+3+bkOpen,bmx+7,bmy);ctx.quadraticCurveTo(bmx,bmy+1,bmx-7,bmy);ctx.closePath();ctx.fill();

  // Stars on body when excited
  if(A.excite>0.3){
    ctx.fillStyle='rgba(255,217,61,'+A.excite+')';
    [[24,-18],[30,-5],[-28,-12],[-32,2]].forEach(([sx,sy])=>{
      ctx.font=`${14*A.excite}px serif`;ctx.textAlign='center';
      ctx.fillText('âœ¦',sx,sy);
    });
  }

  ctx.restore();
}

function frame(){ctx.clearRect(0,0,W,H);drawBG();drawBuddy(W/2,H*.52);}

function tick(){
  A.t+=.016;A.stT+=.016;
  A.breathY=Math.sin(A.t*1.2)*2.5;
  A.headTilt=Math.sin(A.t*.45)*.028;
  A.pupX=Math.sin(A.t*.3)*2.5+Math.sin(A.t*.7)*1.2;
  A.pupY=Math.sin(A.t*.35)*1.8;
  A.blinkNext--;
  if(A.blinkNext<=0){A.blinkT=Math.min(1,A.blinkT+.3);if(A.blinkT>=1){A.blinkT=Math.max(0,A.blinkT-.24);if(A.blinkT<=0)A.blinkNext=120+Math.random()*160;}}
  else A.blinkT=Math.max(0,A.blinkT-.24);

  if(A.state==='idle'){A.browR=lerp(A.browR,0,.05);A.mOpen=lerp(A.mOpen,0,.08);A.mShape=lerp(A.mShape,1,.04);A.waving=lerp(A.waving,0,.05);A.bounce=lerp(A.bounce,0,.06);A.excite=lerp(A.excite,0,.04);}
  else if(A.state==='thinking'){A.browR=lerp(A.browR,.35,.05);A.mOpen=lerp(A.mOpen,.05,.06);A.mShape=lerp(A.mShape,0,.05);A.waving=lerp(A.waving,0,.05);}
  else if(A.state==='speaking'){A.browR=lerp(A.browR,.2,.04);A.phonTimer--;if(A.phonTimer<=0){A.phonIdx=(A.phonIdx+1)%PHON.length;A.phonTimer=2+Math.random()*5;}const[to,ts]=PHON[A.phonIdx];A.mOpen=lerp(A.mOpen,to,.3);A.mShape=lerp(A.mShape,ts,.24);}
  else if(A.state==='listening'){A.browR=lerp(A.browR,.5,.05);A.mOpen=lerp(A.mOpen,.08,.06);}
  else if(A.state==='excited'){A.waving=lerp(A.waving,1,.1);A.waveT+=.14;A.browR=lerp(A.browR,.9,.08);A.mShape=lerp(A.mShape,1,.08);A.mOpen=lerp(A.mOpen,.3,.1);A.bounce=lerp(A.bounce,1,.08)*Math.abs(Math.sin(A.t*8))*6;A.excite=lerp(A.excite,1,.08);if(A.stT>2.5)setState('idle');}
  else if(A.state==='greeting'){A.waving=lerp(A.waving,1,.09);A.waveT+=.13;A.browR=lerp(A.browR,.8,.07);A.mOpen=lerp(A.mOpen,.25,.09);A.mShape=lerp(A.mShape,1,.07);if(A.stT>3)setState('idle');}
  frame();requestAnimationFrame(tick);
}
tick();

function setState(s){
  A.state=s;A.stT=0;
  const d=document.getElementById('sdot'),l=document.getElementById('slbl'),v=document.getElementById('viz'),uv=document.getElementById('uviz'),mb=document.getElementById('micBtn'),ml=document.getElementById('mlbl'),mi=document.getElementById('micIcon');
  d.className='sdot'+(s==='speaking'?' sp':s==='thinking'?' th':s==='listening'?' li':'');
  l.textContent={idle:'Ready!',thinking:'Thinkingâ€¦',speaking:'Buddy is talking!',listening:'Listeningâ€¦',excited:'Yay!',greeting:'Hello!'}[s]||'Ready!';
  v.classList.toggle('on',s==='speaking');
  uv.classList.toggle('on',s==='listening');
  mb.className=s==='listening'?'on':s==='speaking'?'speaking':'';
  mi.textContent=s==='listening'?'ğŸ”´':s==='speaking'?'ğŸ”Š':'ğŸ™ï¸';
  ml.textContent=s==='listening'?'Listening! Tap to stop':s==='speaking'?'Buddy is talking!':'Tap to speak!';
  ml.className='mlbl'+(s==='listening'?' on':s==='speaking'?' sp':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALPHABET & PHONICS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LETTERS=[
  {l:'A',w:'Apple',e:'ğŸ',ph:'/Ã¦/',phWord:'as in Apple',ex:'A is for Apple. A, Apple! ğŸ'},
  {l:'B',w:'Ball',e:'âš½',ph:'/b/',phWord:'as in Ball',ex:'B is for Ball. B, Ball! âš½'},
  {l:'C',w:'Cat',e:'ğŸ±',ph:'/k/',phWord:'as in Cat',ex:'C is for Cat. C, Cat! ğŸ±'},
  {l:'D',w:'Dog',e:'ğŸ¶',ph:'/d/',phWord:'as in Dog',ex:'D is for Dog. D, Dog! ğŸ¶'},
  {l:'E',w:'Elephant',e:'ğŸ˜',ph:'/É›/',phWord:'as in Elephant',ex:'E is for Elephant. E, Elephant! ğŸ˜'},
  {l:'F',w:'Fish',e:'ğŸŸ',ph:'/f/',phWord:'as in Fish',ex:'F is for Fish. F, Fish! ğŸŸ'},
  {l:'G',w:'Grapes',e:'ğŸ‡',ph:'/É¡/',phWord:'as in Grapes',ex:'G is for Grapes. G, Grapes! ğŸ‡'},
  {l:'H',w:'Hat',e:'ğŸ©',ph:'/h/',phWord:'as in Hat',ex:'H is for Hat. H, Hat! ğŸ©'},
  {l:'I',w:'Ice cream',e:'ğŸ¦',ph:'/Éª/',phWord:'as in Ice cream',ex:'I is for Ice cream. I, Ice cream! ğŸ¦'},
  {l:'J',w:'Jellyfish',e:'ğŸª¼',ph:'/dÊ’/',phWord:'as in Jellyfish',ex:'J is for Jellyfish. J, Jellyfish! ğŸª¼'},
  {l:'K',w:'Kite',e:'ğŸª',ph:'/k/',phWord:'as in Kite',ex:'K is for Kite. K, Kite! ğŸª'},
  {l:'L',w:'Lion',e:'ğŸ¦',ph:'/l/',phWord:'as in Lion',ex:'L is for Lion. L, Lion! ğŸ¦'},
  {l:'M',w:'Moon',e:'ğŸŒ™',ph:'/m/',phWord:'as in Moon',ex:'M is for Moon. M, Moon! ğŸŒ™'},
  {l:'N',w:'Nest',e:'ğŸªº',ph:'/n/',phWord:'as in Nest',ex:'N is for Nest. N, Nest! ğŸªº'},
  {l:'O',w:'Orange',e:'ğŸŠ',ph:'/É’/',phWord:'as in Orange',ex:'O is for Orange. O, Orange! ğŸŠ'},
  {l:'P',w:'Penguin',e:'ğŸ§',ph:'/p/',phWord:'as in Penguin',ex:'P is for Penguin. P, Penguin! ğŸ§'},
  {l:'Q',w:'Queen',e:'ğŸ‘‘',ph:'/kw/',phWord:'as in Queen',ex:'Q is for Queen. Q, Queen! ğŸ‘‘'},
  {l:'R',w:'Rainbow',e:'ğŸŒˆ',ph:'/r/',phWord:'as in Rainbow',ex:'R is for Rainbow. R, Rainbow! ğŸŒˆ'},
  {l:'S',w:'Sun',e:'â˜€ï¸',ph:'/s/',phWord:'as in Sun',ex:'S is for Sun. S, Sun! â˜€ï¸'},
  {l:'T',w:'Tiger',e:'ğŸ¯',ph:'/t/',phWord:'as in Tiger',ex:'T is for Tiger. T, Tiger! ğŸ¯'},
  {l:'U',w:'Umbrella',e:'â˜‚ï¸',ph:'/ÊŒ/',phWord:'as in Umbrella',ex:'U is for Umbrella. U, Umbrella! â˜‚ï¸'},
  {l:'V',w:'Volcano',e:'ğŸŒ‹',ph:'/v/',phWord:'as in Volcano',ex:'V is for Volcano. V, Volcano! ğŸŒ‹'},
  {l:'W',w:'Whale',e:'ğŸ‹',ph:'/w/',phWord:'as in Whale',ex:'W is for Whale. W, Whale! ğŸ‹'},
  {l:'X',w:'Xylophone',e:'ğŸµ',ph:'/z/',phWord:'as in Xylophone',ex:'X is for Xylophone. X, Xylophone! ğŸµ'},
  {l:'Y',w:'Yacht',e:'â›µ',ph:'/j/',phWord:'as in Yacht',ex:'Y is for Yacht. Y, Yacht! â›µ'},
  {l:'Z',w:'Zebra',e:'ğŸ¦“',ph:'/z/',phWord:'as in Zebra',ex:'Z is for Zebra. Z, Zebra! ğŸ¦“'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curIdx=0,mode='learn',stars=0,learned=0,answered=false,mc=0;
let isListening=false,recog=null;

// Build alphabet bar
function buildAlphaBar(){
  const bar=document.getElementById('alphaBar');
  bar.innerHTML='';
  LETTERS.forEach((item,i)=>{
    const b=document.createElement('button');
    b.className='ab'+(i===0?' active':'');
    b.textContent=item.l;
    b.onclick=()=>selectLetter(i);
    bar.appendChild(b);
  });
}
buildAlphaBar();

function selectLetter(idx){
  curIdx=idx;
  document.querySelectorAll('.ab').forEach((b,i)=>b.classList.toggle('active',i===idx));
  const bar=document.getElementById('alphaBar');
  bar.children[idx]?.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
  if(mode==='learn')showLearnPanel();
  else if(mode==='quiz')showQuizPanel();
}

function setMode(m){
  mode=m;answered=false;
  ['learn','quiz','chat'].forEach(x=>document.getElementById('tab-'+x).classList.toggle('active',x===m));
  if(m==='learn')showLearnPanel();
  else if(m==='quiz')showQuizPanel();
  else showChatPanel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEARN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLearnPanel(){
  const L=LETTERS[curIdx];
  document.getElementById('topTitle').textContent=`ğŸ“– Learning "${L.l}"`;
  document.getElementById('topSub').textContent=`${L.l} is for ${L.w}!`;
  answered=false;

  const panel=document.getElementById('lesson-panel');
  panel.innerHTML=`
    <div class="prog-bar-bg"><div class="prog-bar-fill" style="width:${((curIdx+1)/26*100).toFixed(0)}%"></div></div>
    <div class="letter-hero">
      <div class="big-letter">${L.l}</div>
      <div class="letter-word">${L.l} is for ${L.w}</div>
      <div class="letter-emoji">${L.e}</div>
      <div class="letter-phonics">ğŸ”Š Sound: ${L.ph} â€” ${L.phWord}</div>
      <div class="letter-sentence">"${L.ex}"</div>
    </div>
    <div class="buddy-says" id="buddySays">Hi! I'm Buddy! Today we learn the letter ${L.l}! ${L.l} is for ${L.w}! ${L.e}</div>
    <div class="action-row">
      <button class="abtn hear" onclick="hearLetter()">ğŸ”Š Hear it!</button>
      <button class="abtn next" onclick="nextLetter()" id="nextBtn">Next Letter âœ</button>
    </div>
  `;

  setTimeout(()=>teachLetter(L), 400);
}

function teachLetter(L){
  speakText(`${L.l}! ${L.l} is for ${L.w}! ${L.e}. ${L.l}, ${L.w}. Can you say ${L.l}?`,()=>{});
  setState('speaking');
}

function hearLetter(){
  const L=LETTERS[curIdx];
  speakText(`${L.l}! ${L.l} for ${L.w}! ${L.l}, ${L.l}, ${L.l}!`,()=>{setState('idle');});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIZ PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showQuizPanel(){
  const L=LETTERS[curIdx];
  document.getElementById('topTitle').textContent=`ğŸ¯ Quiz Time!`;
  document.getElementById('topSub').textContent=`Which letter makes this sound?`;
  answered=false;

  // Make 3 wrong choices
  let opts=[L.l];
  while(opts.length<4){const r=LETTERS[Math.floor(Math.random()*26)].l;if(!opts.includes(r))opts.push(r);}
  opts.sort(()=>Math.random()-.5);

  const panel=document.getElementById('lesson-panel');
  panel.innerHTML=`
    <div class="prog-bar-bg"><div class="prog-bar-fill" style="width:${((curIdx+1)/26*100).toFixed(0)}%"></div></div>
    <div class="letter-hero" style="padding:14px 14px 12px;">
      <div class="letter-emoji" style="font-size:72px;margin:0 0 8px;">${L.e}</div>
      <div class="letter-word" style="font-size:22px;">${L.w}</div>
      <div class="letter-phonics" style="margin-top:6px;">Sound: ${L.ph}</div>
    </div>
    <div class="buddy-says" id="buddySays">Which letter is "${L.l.toLowerCase()}"? Tap the right letter! ğŸ¯</div>
    <div class="choices-wrap" id="choicesWrap">
      ${opts.map(o=>`<button class="choice" onclick="checkAnswer('${o}','${L.l}',this)">${o}</button>`).join('')}
    </div>
    <button class="abtn next" onclick="nextLetter()" id="nextBtn" disabled style="margin-top:0;">Next âœ</button>
  `;

  speakText(`Which letter is this? ${L.w} starts with the letterâ€¦ can you find it?`,()=>{});
}

function checkAnswer(chosen,correct,btn){
  if(answered)return;
  answered=true;
  const L=LETTERS[curIdx];

  // Highlight the chosen button
  if(btn) btn.classList.add(chosen===correct?'correct':'wrong');

  // Always highlight the correct answer clearly
  if(chosen!==correct){
    document.querySelectorAll('.choice').forEach(b=>{
      if(b.textContent.trim()===correct) b.classList.add('correct');
    });
  }

  // Disable all choices after answering
  document.querySelectorAll('.choice').forEach(b=>b.style.pointerEvents='none');

  if(chosen===correct){
    stars+=2;
    document.getElementById('starCount').textContent=stars;
    learned++;
    document.getElementById('lessonCount').textContent=learned;
    const buddySaysEl=document.getElementById('buddySays');
    if(buddySaysEl) buddySaysEl.textContent=`Amazing! ${correct} is correct! ${correct} is for ${L.w}! You got 2 stars! Well done!`;
    setState('excited');
    confetti();
    speakText(`Yes! Amazing! ${correct}! ${correct} is for ${L.w}! You are so smart! You earned 2 stars! Well done!`,()=>{setState('idle');});
  } else {
    const buddySaysEl=document.getElementById('buddySays');
    if(buddySaysEl) buddySaysEl.textContent=`Almost! The letter is ${correct}. ${correct} is for ${L.w}. You will get it next time!`;
    speakText(`Oops! The answer is ${correct}. ${correct} is for ${L.w}. Keep trying, you can do it!`,()=>{setState('idle');});
  }

  const nextBtn=document.getElementById('nextBtn');
  if(nextBtn) nextBtn.disabled=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showChatPanel(){
  document.getElementById('topTitle').textContent='ğŸ’¬ Chat with Buddy';
  document.getElementById('topSub').textContent='Ask Buddy anything about letters!';
  document.getElementById('lesson-panel').innerHTML=`<div class="chat-wrap" id="chatWrap"></div>`;
  addChatMsg(`Hi there! ğŸ‘‹ I'm Buddy your owl tutor! Ask me about any letter, phonics sound, or just say hello! You can also tap the mic to speak! ğŸ™ï¸`,'b');
}

function addChatMsg(text,role,html=''){
  let wrap=document.getElementById('chatWrap');
  if(!wrap){document.getElementById('lesson-panel').innerHTML='<div class="chat-wrap" id="chatWrap"></div>';wrap=document.getElementById('chatWrap');}
  const id='m'+(++mc),now=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),isB=role==='b';
  const row=document.createElement('div');row.className='mr'+(isB?'':' u');row.id=id;
  const av=document.createElement('div');av.className='mav'+(isB?'':' u');av.textContent=isB?'ğŸ¦‰':'ğŸ‘¤';
  const bub=document.createElement('div');bub.className='bub '+(isB?'b':'u');
  if(html)bub.innerHTML=html;else bub.textContent=text;
  const mt=document.createElement('div');mt.className='mt';mt.textContent=now;
  const mw=document.createElement('div');mw.className='mw'+(isB?'':' u');
  mw.appendChild(bub);mw.appendChild(mt);row.appendChild(av);row.appendChild(mw);
  wrap.appendChild(row);document.getElementById('lesson-panel').scrollTop=99999;return id;
}
function removeMsg(id){document.getElementById(id)?.remove();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFV(){
  const vs=speechSynthesis.getVoices();
  for(const n of['Samantha','Karen','Moira','Victoria','Tessa','Google US English','Microsoft Aria Online','Microsoft Zira']){const v=vs.find(x=>x.name.includes(n));if(v)return v;}
  return vs.find(v=>/en/i.test(v.lang))||vs[0]||null;
}
function speakText(text,onEnd){
  if(!('speechSynthesis'in window)){setState('idle');onEnd&&onEnd();return;}
  speechSynthesis.cancel();
  // Remove emojis and special chars safely, keep words + punctuation
  const clean=text.replace(/[\uD800-\uDFFF]|[\u2600-\u27FF]|[\u{1F000}-\u{1FFFF}]/gu,' ')
    .replace(/[^\w\s,.!?'"%-]/g,' ').replace(/\s+/g,' ').trim().slice(0,400);
  if(!clean){setState('idle');onEnd&&onEnd();return;}
  const go=()=>{
    const u=new SpeechSynthesisUtterance(clean);
    const v=getFV();if(v)u.voice=v;
    u.rate=.82;u.pitch=1.15;u.volume=1;
    u.onstart=()=>setState('speaking');
    u.onend=()=>{setState('idle');onEnd&&onEnd();};
    u.onerror=()=>{setState('idle');onEnd&&onEnd();};
    speechSynthesis.speak(u);
  };
  // Small delay so speechSynthesis.cancel() has time to clear
  setTimeout(()=>{
    speechSynthesis.getVoices().length===0
      ?speechSynthesis.onvoiceschanged=(()=>{go();speechSynthesis.onvoiceschanged=null;})
      :go();
  },80);
}

// SPEECH-TO-SPEECH
function toggleListen(){
  if(isListening){stopListen();}
  else{startListen();}
}
function startListen(){
  if(!('webkitSpeechRecognition'in window||'SpeechRecognition'in window)){
    if(mode!=='chat')showChatPanel();
    addChatMsg('Speech input needs Chrome! Use text below instead.','b');return;
  }
  speechSynthesis.cancel();
  setState('listening');isListening=true;
  let gotResult=false; // â† flag to prevent onend firing before onresult
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recog=new SR();
  recog.continuous=false;
  recog.interimResults=true;
  recog.lang='en-US';
  recog.onresult=e=>{
    let interim='',final='';
    for(const r of e.results){if(r.isFinal)final+=r[0].transcript;else interim+=r[0].transcript;}
    showLiveT(final||interim);
    if(final){
      gotResult=true;
      stopListen();
      handleVoiceInput(final.trim());
    }
  };
  recog.onerror=e=>{
    console.warn('Mic error:',e.error);
    stopListen();
    if(e.error==='not-allowed') addChatMsg('Microphone blocked! Please allow mic access and try again. ğŸ™ï¸','b');
  };
  recog.onend=()=>{
    // Only stop if we didn't already handle a result (prevents race condition)
    if(!gotResult && isListening) stopListen();
  };
  recog.start();
}
function stopListen(){isListening=false;if(recog){recog.stop();recog=null;}showLiveT('');if(A.state==='listening')setState('idle');}
function showLiveT(t){const el=document.getElementById('liveT'),tx=document.getElementById('ltText');if(t){el.classList.add('show');tx.textContent=t;}else el.classList.remove('show');}

async function handleVoiceInput(text){
  const upper=text.trim().toUpperCase();
  const lower=text.trim().toLowerCase();

  // â”€â”€ QUIZ MODE: check if the spoken answer matches a letter choice â”€â”€
  if(mode==='quiz' && !answered){
    // Accept single letter ("A", "bee", "the letter B", "I think it's C")
    const spokenLetter=extractLetter(text);
    if(spokenLetter){
      const L=LETTERS[curIdx];
      // Simulate clicking the matching choice button
      const btns=[...document.querySelectorAll('.choice')];
      const matchBtn=btns.find(b=>b.textContent.trim()===spokenLetter);
      if(matchBtn){
        checkAnswer(spokenLetter, L.l, matchBtn);
        return;
      }
    }
  }

  // â”€â”€ LEARN MODE: confirm the letter they said and teach it â”€â”€
  if(mode==='learn'){
    const spokenLetter=extractLetter(text);
    if(spokenLetter){
      const idx=LETTERS.findIndex(x=>x.l===spokenLetter);
      if(idx>=0){
        selectLetter(idx);
        const L=LETTERS[idx];
        setTimeout(()=>speakText(`Yes! ${L.l}! ${L.l} is for ${L.w}! Great job saying ${L.l}!`,()=>{}),400);
        return;
      }
    }
    // They said the word (e.g. "Apple")
    const wordMatch=LETTERS.find(x=>lower.includes(x.w.toLowerCase()));
    if(wordMatch){
      const idx=LETTERS.indexOf(wordMatch);
      selectLetter(idx);
      setTimeout(()=>speakText(`${wordMatch.w}! That starts with the letter ${wordMatch.l}! ${wordMatch.l} for ${wordMatch.w}! Amazing!`,()=>{}),400);
      return;
    }
  }

  // â”€â”€ CHAT MODE or unrecognised: send to AI â”€â”€
  if(mode!=='chat') setMode('chat');
  addChatMsg(text,'u');
  showLiveT('');
  setState('thinking');
  const lid=addChatMsg('','b','<div class="dl-wrap"><div class="dl"></div><div class="dl"></div><div class="dl"></div></div>');
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',max_tokens:200,
        system:`You are Buddy, an enthusiastic friendly owl tutor for kids aged 3-8. You teach A-Z alphabets and phonics.
- Keep answers SHORT (2-3 sentences max). Very simple words only.
- Always be warm, encouraging, and fun. Use exclamation marks!
- If asked about a letter, say: the letter name, a word starting with it, and encourage them
- End with a fun question or encouragement
- No complex vocabulary, no markdown, no bullet points â€” plain speech only`,
        messages:[{role:'user',content:text}]
      })
    });
    const d=await r.json();
    removeMsg(lid);
    const reply=d.content?.[0]?.text||`Great question! ${LETTERS[curIdx].l} is for ${LETTERS[curIdx].w}! Can you say ${LETTERS[curIdx].l}?`;
    addChatMsg(reply,'b');
    speakText(reply,()=>{});
  }catch(e){
    removeMsg(lid);
    const fb=`Great question! ${LETTERS[curIdx].l} is for ${LETTERS[curIdx].w}! Can you say ${LETTERS[curIdx].l}?`;
    addChatMsg(fb,'b');
    speakText(fb,()=>{});
  }
}

// Helper: extract a single spoken letter from text like "A", "the letter B", "I think C", "bee", "ay"
function extractLetter(text){
  const upper=text.trim().toUpperCase();
  // Direct single letter
  if(/^[A-Z]$/.test(upper)) return upper;
  // "The letter X" or "letter X"
  const m1=upper.match(/\bLETTER\s+([A-Z])\b/);if(m1)return m1[1];
  // "I think it's X" / "it is X" / "answer is X"
  const m2=upper.match(/\b(?:IS|IT'S|ITS|THINK|ANSWER|CHOOSE|PICK|SAY)\s+([A-Z])\b/);if(m2)return m2[1];
  // Phonetic alphabet names â†’ letter (bâ†’B, câ†’C, etc.)
  const phonetic={'AY':'A','BEE':'B','CEE':'C','DEE':'D','EE':'E','EF':'F','GEE':'G',
    'HI':'H','AITCH':'H','EYE':'I','JAY':'J','KAY':'K','EL':'L','EM':'M',
    'EN':'N','OH':'O','PEE':'P','CUE':'Q','QUE':'Q','AR':'R','ESS':'S',
    'TEE':'T','YOU':'U','VEE':'V','WE':'W','EX':'X','WHY':'Y','ZEE':'Z','ZED':'Z'};
  const words=upper.replace(/[^A-Z\s]/g,'').trim().split(/\s+/);
  // Single word phonetic
  if(words.length===1&&phonetic[words[0]])return phonetic[words[0]];
  // Last word in sentence might be the letter
  const last=words[words.length-1];
  if(/^[A-Z]$/.test(last))return last;
  if(phonetic[last])return phonetic[last];
  return null;
}

function sendText(){const inp=document.getElementById('ci'),t=inp.value.trim();if(!t)return;inp.value='';handleVoiceInput(t);}
document.getElementById('ci').addEventListener('keydown',e=>{if(e.key==='Enter')sendText();});

function prevLetter(){selectLetter(Math.max(0,curIdx-1));}
function nextLetter(){selectLetter(Math.min(25,curIdx+1));}

function clearChat(){if(mode==='chat')showChatPanel();else if(mode==='learn')showLearnPanel();else showQuizPanel();}

// CONFETTI
function confetti(){
  const colors=['#FFD93D','#FF6B6B','#6BCB77','#6EC6F5','#c77dff'];
  for(let i=0;i<18;i++){
    const el=document.createElement('div');
    el.style.cssText=`position:fixed;left:${Math.random()*100}%;top:-10px;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;background:${colors[Math.floor(Math.random()*5)]};border-radius:${Math.random()>.5?'50%':'2px'};animation:fall ${.8+Math.random()*1.2}s linear ${Math.random()*.4}s forwards;z-index:999;pointer-events:none;`;
    document.body.appendChild(el);setTimeout(()=>el.remove(),2500);
  }
}
if(!document.getElementById('fallStyle')){const s=document.createElement('style');s.id='fallStyle';s.textContent='@keyframes fall{from{transform:translateY(0) rotate(0);opacity:1}to{transform:translateY(100vh) rotate(720deg);opacity:0}}';document.head.appendChild(s);}

// INIT
window.addEventListener('load',()=>{
  setState('greeting');
  showLearnPanel();
  setTimeout(()=>{
    const g=`Hello! I'm Buddy your owl teacher! ğŸ¦‰ Let's learn the alphabet together! Today we start with the letter ${LETTERS[0].l}! ${LETTERS[0].l} is for ${LETTERS[0].w}! ${LETTERS[0].e} Tap the mic to speak or tap any letter below!`;
    speakText(g,()=>{});
  },700);
});
</script>
</body>
</html>
